#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

const int LINE_SIZE = 1024;

typedef struct Person {
    int  age;
    double ga_ctg;
    double ga_b;
    char sex;
    double weight;
    double a1;
    double a5;

} Person;

char* getfield(char* line, int num)
{
    char* tok;
    for (tok = strtok(line, ";"); tok && *tok; tok = strtok(NULL, ";\n")){
        if (!--num)
            return tok;
    }
    return NULL;
}

int main(){
    FILE* file = fopen("/home/karol/Downloads/ExampleCSV.csv", "r");
    char line[LINE_SIZE];

    Person* people;
    int count = 0;

    if (file == NULL) {
        perror("Error opening file");
        return -1;
    }

    //Count the number of columns to know how to allocate properly URGENT!!!
    char ch;
    int column_Number = 0;
    int line_Number = 0;

    while((ch=fgetc(file))!=EOF) {
        if(ch==';'){
            column_Number++;
            line_Number++;
        }
        if (ch == '\n')
            break;
    }
    printf("Number of columns: %d \n", column_Number + 1); //Plus one because the number of ; is -1 number of columns

    //

    while (fgets(line, LINE_SIZE, file)){count++;} // counts the number of lines in file

    // decreases count by one (since it will ignore first line of data)
    count--;

    if(count < 1) // no data
        return 0;

    // allocate memory for the age array
    people = (Person*)malloc(count * sizeof(Person));

    if (people == NULL) {
        perror("error allocating people array");
        exit(0);
    }

    rewind(file); // rewinds file

    fgets(line, LINE_SIZE, file); // reads first line (column names) and do nothing

    count = 0; // reset count to use it as array index
    while (fgets(line, LINE_SIZE, file))
    {
        char temp[LINE_SIZE];
        // Get every column of row as char*
        char* age = getfield(strcpy(temp, line), 1);
        char* ga_ctg = getfield(strcpy(temp, line), 2);
        char* ga_b = getfield(strcpy(temp, line), 3);
        char* sex = getfield(strcpy(temp, line), 4);
        char* weight = getfield(strcpy(temp, line), 5);
        char* a1 = getfield(strcpy(temp, line), 6);
        char* a5 = getfield(strcpy(temp, line), 7);
        // stores converted values in the person array
        people[count].age = atoi(age);
        people[count].ga_ctg = atof(ga_ctg);
        people[count].ga_b = atof(ga_b);
        people[count].sex = sex[0];
        people[count].weight = atof(weight);
        people[count].a1 = atof(a1);
        people[count].a5 = atof(a5);
        // -------------------------------------------

        count++;
    }

    // debugs array
    for (int i = 0; i < count; i++) {
        printf("age: %d | ga_ctg: %.2f | ga_b: %.2f | sex: %c | weight: %.2f | a1: %.2f | a5: %.2f\n",
               people[i].age, people[i].ga_ctg, people[i].ga_b, people[i].sex,
               people[i].weight, people[i].a1, people[i].a5);
    }

    //Sum all the elements inside the a1 array
    int j;
    int sum;
    for (j = 0; j < count; ++j){
        //The number of elements inside the array will be equal the number of lines - the title of the table

        sum += people[j].a1;
    }
    printf("\nThe sum of the elements inside the array a1 would it be: %d?\n", sum);

    //Do the arithmetic mean of the elements from the array a1

    float me;

    me = (float) sum/(float) count;

    printf("\nThe arithmetic mean would it be: %f?\n",me);


    //Variance
int sum1;
float variance;
    for (int p = 0; p < count; p++)
    {
        sum1 = sum1 + pow(((people[p].a1) - me), 2);
    }
variance = sum1 / (float) count;
    printf("\nVariance would it be: %.2f\n", variance);


    fclose(file);
    //free(people);

    return 0;
}

